<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#e11d48">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>BlockHunt â€¢ Code Studio</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Blockly (ORDER MATTERS) -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/blocks.min.js"></script>
  <script src="https://unpkg.com/blockly/python_compressed.js"></script>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

  <link href="../styles.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon.png">
</head>
<body>

  <!-- Desktop Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="home.html">
        <i class="bi bi-qr-code-scan"></i> BlockHunt
      </a>
    </div>
  </nav>

  <!-- Mobile AppBar -->
  <div class="appbar py-2">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="brand">BlockHunt</div>
    </div>
  </div>

  <!-- Main -->
  <main class="container py-4">
    <!-- Sticky Action Bar: Buttons only -->
    <div class="actionbar">
      <div class="container py-2 d-flex flex-wrap gap-2 justify-content-end">
        <button class="btn btn-ghost" id="btnSave"><i class="bi bi-save me-1"></i>Save</button>
        <button class="btn btn-ghost" id="btnSubmit"><i class="bi bi-upload me-1"></i>Submit</button>
        <button class="btn btn-ghost" id="btnDownload"><i class="bi bi-download me-1"></i>Download .py</button>
        <button class="btn btn-brand" id="btnRun"><i class="bi bi-play-fill me-1"></i>Run</button>
      </div>
    </div>

    <!-- Question Panel: Long text OK -->
    <div class="panel p-3 mb-3">
      <div class="small text-uppercase text-muted fw-bold">Programming Question</div>
      <div id="questionText" class="fw-semibold">
        Write a program that reads an integer <em>n</em> and prints the sum of all integers from 1 to <em>n</em>.
        If <em>n</em> is negative, print <code>0</code>. For example, input <code>5</code> should output <code>15</code>.
        You may assume input is a single line with a valid integer.
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-7">
        <div class="panel p-3">
          <h6 class="panel-title mb-2">Workspace</h6>
          <div id="blocklyArea">
            <div id="blocklyDiv"></div>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="panel p-3 mb-3">
          <h6 class="mb-2">Console Output</h6>
          <pre id="console" class="console-box mb-0">(no output)</pre>
        </div>

        <div class="panel p-3">
          <h6 class="mb-2">Generated Python</h6>
          <pre id="pyCode" class="code-box mb-0" style="white-space:pre-wrap"></pre>
        </div>
      </div>
    </div>
  </main>
    <button class="fab d-inline-flex align-items-center" id="fabScan">
  <i class="bi bi-play-fill"></i><span class="fab-label">Run</span>
</button>

  <a href="admin.html"><button class="fab fab--secondary fab-admin fab--sm" id="fabAdmin" aria-label="Open Admin">
    <i class="bi bi-shield-lock"></i><span class="fab-label">Admin</span>
  </button></a>


  <!-- Bottom Tab Bar -->
  <nav class="tabbar d-flex align-items-center gap-2">
    <a class="tab" href="home.html"><i class="bi bi-house"></i><span class="label">Home</span></a>
    <a class="tab" href="challenges.html"><i class="bi bi-list-task"></i><span class="label">Challenges</span></a>
    <a class="tab active" href="studio.html"><i class="bi bi-code-slash"></i><span class="label">Studio</span></a>
    <a class="tab" href="profile.html"><i class="bi bi-person"></i><span class="label">Profile</span></a>
  </nav>

  <!-- Scripts -->
  <script>
    // ===== Toolbox (Python-safe subset) =====
    function buildToolbox(){
      return `
<xml id="toolbox" style="display:none">
  <category name="Logic" colour="#5CA65C">
    <block type="controls_if"></block>
    <block type="logic_compare"></block>
    <block type="logic_operation"></block>
    <block type="logic_negate"></block>
    <block type="logic_boolean"></block>
    <block type="logic_null"></block>
    <block type="logic_ternary"></block>
  </category>

  <category name="Loops" colour="#5CA65C">
    <block type="controls_repeat_ext">
      <value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
    </block>
    <block type="controls_whileUntil"></block>
    <block type="controls_for">
      <value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
      <value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
      <value name="BY"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
    </block>
    <block type="controls_forEach"></block>
    <block type="controls_flow_statements"></block>
  </category>

  <category name="Math" colour="#5C68A6">
    <block type="math_number"><field name="NUM">0</field></block>
    <block type="math_arithmetic"></block>
    <block type="math_single"></block>
    <block type="math_trig"></block>
    <block type="math_constant"></block>
    <block type="math_number_property"></block>
    <block type="math_change">
      <value name="DELTA"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
    </block>
    <block type="math_round"></block>
    <block type="math_modulo"></block>
    <block type="math_random_int">
      <value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
      <value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
    </block>
    <block type="math_random_float"></block>
  </category>

  <category name="Text" colour="#5CA699">
    <block type="text"></block>
    <block type="text_join"></block>
    <block type="text_length"></block>
    <block type="text_isEmpty"></block>
    <block type="text_indexOf"></block>
    <block type="text_charAt"></block>
    <block type="text_getSubstring"></block>
    <block type="text_changeCase"></block>
    <block type="text_trim"></block>
    <block type="text_print"></block>
  </category>

  <category name="Lists" colour="#745CA6">
    <block type="lists_create_with"></block>
    <block type="lists_create_with"><mutation items="0"></mutation></block>
    <block type="lists_repeat">
      <value name="NUM"><shadow type="math_number"><field name="NUM">5</field></shadow></value>
    </block>
    <block type="lists_length"></block>
    <block type="lists_isEmpty"></block>
    <block type="lists_indexOf"></block>
    <block type="lists_getIndex"></block>
    <block type="lists_setIndex"></block>
    <block type="lists_getSublist"></block>
    <block type="lists_split"></block>
    <block type="lists_sort"></block>
  </category>

  <category name="Variables" custom="VARIABLE" colour="#A65C81"></category>
  <category name="Functions" custom="PROCEDURE" colour="#5CA65C"></category>
</xml>`;
    }

    // ===== Blockly + Pyodide wiring (using serialization API) =====
    let workspace;
    let pyodideReady = null;
    const LS_KEY = 'BlockHunt_workspace_v2';

    function initBlockly(){
      const area = document.getElementById('blocklyArea');
      const div  = document.getElementById('blocklyDiv');

      function onResize(){
        const r = area.getBoundingClientRect();
        div.style.width  = r.width  + 'px';
        div.style.height = r.height + 'px';
        if (workspace) Blockly.svgResize(workspace);
      }
      window.addEventListener('resize', onResize);

      const toolboxDom = new DOMParser().parseFromString(buildToolbox(), 'text/xml').documentElement;

      workspace = Blockly.inject('blocklyDiv', {
        toolbox: toolboxDom,
        trashcan: true,
        renderer: 'zelos',
        zoom: { controls: true, wheel: true }
      });

      onResize();

      // Restore saved state (JSON) or seed an initial block
      const saved = localStorage.getItem(LS_KEY);
      if (saved){
        try {
          Blockly.serialization.workspaces.load(JSON.parse(saved), workspace);
        } catch(e){
          console.warn('Failed to load saved workspace:', e);
          seedWorkspace();
        }
      } else {
        seedWorkspace();
      }
    }

    function seedWorkspace(){
      const seedState = {
        "blocks": {
          "languageVersion": 0,
          "blocks": [
            {
              "type": "text_print",
              "x": 30, "y": 30,
              "inputs": {
                "TEXT": {
                  "shadow": {
                    "type": "text",
                    "fields": { "TEXT": "Hello BlockHunt!" }
                  }
                }
              }
            }
          ]
        }
      };
      Blockly.serialization.workspaces.load(seedState, workspace);
    }

    async function bootPyodide(){
      if (pyodideReady) return pyodideReady;
      pyodideReady = loadPyodide(); // CDN script supplies loadPyodide()
      return pyodideReady;
    }

    function getPython(){
      const gen = Blockly.Python || Blockly['Python'];
      if (!gen){
        document.getElementById('console').textContent =
          '[Error] Blockly Python generator not loaded.\nInclude "python_compressed.js" after blockly.min.js.';
        return '';
      }
      return gen.workspaceToCode(workspace || null);
    }

    async function runPython(code){
      const py = await bootPyodide();
      let out = '';
      py.setStdout({ batched:(s)=>{ out += s } });
      py.setStderr({ batched:(s)=>{ out += s } });
      try { await py.runPythonAsync(code) }
      catch(e){ out += `\n[Error] ${e.message}` }
      return out;
    }

    // ===== Actions =====
    function toast(msg){
      const el = document.createElement('div');
      el.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-4 px-3 py-2 rounded-3 text-white';
      el.style.background = 'rgba(15,23,42,.9)';
      el.style.zIndex = 2000;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 1400);
    }

    function doSave(){
      const state = Blockly.serialization.workspaces.save(workspace);
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      toast('Saved locally.');
    }

    async function doRun(){
      const code = getPython();
      if (!code) return;
      document.getElementById('pyCode').textContent = code;
      document.getElementById('console').textContent = 'Running...';
      const output = await runPython(code);
      document.getElementById('console').textContent = output || '(no output)';
    }

    function doDownload(){
      const code = getPython();
      if (!code) return;
      const blob = new Blob([code], {type:'text/x-python'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'solution.py';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function doSubmit(){
      const code = getPython();
      const state = Blockly.serialization.workspaces.save(workspace);
      console.log('[Submit] code:', code);
      console.log('[Submit] state:', state);

      toast('Submitted! (demo)');
    }

    function openScanner(e){
      if(e) e.preventDefault();
      const AR_DEEPLINK = 'BlockHunt://scan';
      const AR_WEB_FALLBACK = 'profile.html#simulate-scan';
      window.location.href = AR_DEEPLINK;
      setTimeout(()=>{ window.location.href = AR_WEB_FALLBACK }, 600);
    }

    // ===== Wire up =====
    document.addEventListener('DOMContentLoaded', () => {
      initBlockly();

      document.getElementById('btnSave')?.addEventListener('click', doSave);
      document.getElementById('btnSubmit')?.addEventListener('click', doSubmit);
      document.getElementById('btnDownload')?.addEventListener('click', doDownload);
      document.getElementById('btnRun')?.addEventListener('click', doRun);

      document.getElementById('fabRun')?.addEventListener('click', doRun);
      document.getElementById('tabScan')?.addEventListener('click', openScanner);
    });
    document.getElementById('fabAdmin')?.addEventListener('click', () => {
  window.location.href = 'admin.html';
});
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
